{% load static %}
<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Think&Coffe'House</title>
    <link rel="stylesheet" href="{% static 'css/normalize.css' %}">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Open+Sans&family=PT+Sans:wght@400;700&display=swap">
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <style>
        /* Estilos para el menú desplegable */
        .usuario-menu {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            background-color: white;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            border-radius: 5px;
            padding: 10px;
            min-width: 180px;
            z-index: 1000;
        }

        .usuario-menu a {
            display: block;
            padding: 8px;
            color: #333;
            text-decoration: none;
        }

        .usuario-menu a:hover {
            background-color: #f0f0f0;
        }

        .usuario-info {
            cursor: pointer;
            color: white;
            font-weight: bold;
            padding: 0 10px;
        }

        #nombre-usuario {
            color: white;
        }
    </style>
</head>

<body>

    <header class="header">

        <div class="contenedor">
            <div class="barra">
                <a class="logo" href="{% url 'index'%}">
                    <h1 class="logo_nombre no-margin centrar-texto">Think&<span class="logo_bold">Coffe</span>'house</h1>
                </a>

                <nav class="navegacion">
                    <a href="#" class="navegacion_enlace">Nosotros</a>
                    <a href="#" class="navegacion_enlace">Productos</a>
                    <a href="#" class="navegacion_enlace">Contacto</a>
                    <a href="{% url 'login' %}" id="login-link" class="navegacion_enlace">Iniciar Sesión</a>
                    
                    <div id="usuario-info" class="usuario-info" style="display: none; position: relative;">
                        <span id="nombre-usuario"></span>
                        <div class="usuario-menu">
                            <a href="#" id="update-password">Cambiar contraseña</a>
                            <a href="#" id="delete-account">Eliminar cuenta</a>
                        </div>
                    </div>
                </nav>
                
            </div>
        </div>

        <div class="header_texto">
            <h2 class="no_margin">Tienda de café de calidad y nuevos sabores</h2>
            <p class="no_margin">Disfruta de una deliciosa taza de cafe en tus mañanas</p>
        </div>
    </header>

    <div class="contenedor contenido-principal">
        <main class="blog">
            <h3 class="centrar-texto">Nuestros tipos de café</h3>

            <article class="entrada">
                <div class="entrada_imagen">
                    <img src="{% static 'img/producto1.jpg'%}" alt="imagen blog">
                </div>

                <div class="entrada_contenido">
                    <h4 class="no-margin">Granos de Café molido</h4>
                    <p>Lorem ipsum dolor sit amet consectetur, adipisicing elit. 
                        In sit vitae aspernatur nihil optio vel exercitationem. 
                        Recusandae impedit aspernatur officiis distinctio ex dolorum eum, ab fugit voluptate 
                        maxime! Amet, neque.</p>
                        <a href="#" class="boton boton--primario">Leer Entrada</a>
                </div>
            </article>

            <article class="entrada">
                <div class="entrada_imagen">
                    <img src="{% static 'img/producto2.jpg'%}" alt="imagen blog">
                </div>

                <div class="entrada_contenido">
                    <h4 class="no-margin">Grano de Café Tostados</h4>
                    <p>Lorem ipsum dolor sit amet consectetur, adipisicing elit. 
                        In sit vitae aspernatur nihil optio vel exercitationem. 
                        Recusandae impedit aspernatur officiis distinctio ex dolorum eum, ab fugit voluptate 
                        maxime! Amet, neque.</p>
                        <a href="#" class="boton boton--primario">Leer Entrada</a>
                </div>
            </article>

            <article class="entrada">
                <div class="entrada_imagen">
                    <img src="{% static 'img/producto3.jpg'%}" alt="imagen blog">
                </div>

                <div class="entrada_contenido">
                    <h4 class="no-margin">Grano de Café tostado ligero</h4>
                    <p>Lorem ipsum dolor sit amet consectetur, adipisicing elit. 
                        In sit vitae aspernatur nihil optio vel exercitationem. 
                        Recusandae impedit aspernatur officiis distinctio ex dolorum eum, ab fugit voluptate 
                        maxime! Amet, neque.</p>
                        <a href="#" class="boton boton--primario">Leer Entrada</a>
                </div>
            </article>

        </main>

        <aside class="sidebar">
            <h3>Nuestros Productos</h3>

            <ul class="producto no-padding">
                <li class="widget-producto">
                    <h4 class="no-margin">Café Golden</h4>
                    <p class="widget-producto__label">Precio:
                        <span class="widget-producto__info">$10.000</span>
                    </p>
                    <p class="widget-producto__label">Cantidad:
                        <span class="widget-producto__info">10</span>
                    </p>
                    <a href="{% url 'detalleproducto'%}" class="boton boton--secundario">Más Información</a>
                </li>

                <li class="widget-producto">
                    <h4 class="no-margin">Café Premium</h4>
                    <p class="widget-producto__label">Precio:
                        <span class="widget-producto__info">$16.000</span>
                    </p>
                    <p class="widget-producto__label">Cantidad:
                        <span class="widget-producto__info">8</span>
                    </p>
                    <a href="{% url 'detalleproducto'%}" class="boton boton--secundario">Más Información</a>
                </li>

                <li class="widget-producto">
                    <h4 class="no-margin">Café Elite</h4>
                    <p class="widget-producto__label">Precio:
                        <span class="widget-producto__info">$20.000</span>
                    </p>
                    <p class="widget-producto__label">Cantidad:
                        <span class="widget-producto__info">4</span>
                    </p>
                    <a href="{% url 'detalleproducto'%}" class="boton boton--secundario">Más Información</a>
                </li>

                <li class="widget-producto">
                    <h4 class="no-margin">Café Power</h4>
                    <p class="widget-producto__label">Precio:
                        <span class="widget-producto__info">$22.000</span>
                    </p>
                    <p class="widget-producto__label">Cantidad:
                        <span class="widget-producto__info">6</span>
                    </p>
                    <a href="{% url 'detalleproducto'%}" class="boton boton--secundario">Más Información</a>
                </li>

                <li class="widget-producto">
                    <h4 class="no-margin">Café Ultimate</h4>
                    <p class="widget-producto__label">Precio:
                        <span class="widget-producto__info">$25.000</span>
                    </p>
                    <p class="widget-producto__label">Cantidad:
                        <span class="widget-producto__info">5</span>
                    </p>
                    <a href="{% url 'detalleproducto'%}" class="boton boton--secundario">Más Información</a>
                </li>

                <li class="widget-producto">
                    <h4 class="no-margin">Café Ultimate Platino</h4>
                    <p class="widget-producto__label">Precio:
                        <span class="widget-producto__info">$26.000</span>
                    </p>
                    <p class="widget-producto__label">Cantidad:
                        <span class="widget-producto__info">16</span>
                    </p>
                    <a href="{% url 'detalleproducto'%}" class="boton boton--secundario">Más Información</a>
                </li>

                <li class="widget-producto">
                    <h4 class="no-margin">Café Ultimate Premium</h4>
                    <p class="widget-producto__label">Precio:
                        <span class="widget-producto__info">$30.000</span>
                    </p>
                    <p class="widget-producto__label">Cantidad:
                        <span class="widget-producto__info">20</span>
                    </p>
                    <a href="{% url 'detalleproducto'%}" class="boton boton--secundario">Más Información</a>
                </li>

                <li class="widget-producto">
                    <h4 class="no-margin">Café Divino</h4>
                    <p class="widget-producto__label">Precio:
                        <span class="widget-producto__info">$32.000</span>
                    </p>
                    <p class="widget-producto__label">Cantidad:
                        <span class="widget-producto__info">23</span>
                    </p>
                    <a href="{% url 'detalleproducto'%}" class="boton boton--secundario">Más Información</a>
                </li>

                <li class="widget-producto">
                    <h4 class="no-margin">Café Hacking</h4>
                    <p class="widget-producto__label">Precio:
                        <span class="widget-producto__info">$36.000</span>
                    </p>
                    <p class="widget-producto__label">Cantidad:
                        <span class="widget-producto__info">Sin Stock</span>
                    </p>
                    <a href="{% url 'detalleproducto'%}" class="boton boton--secundario">Más Información</a>
                </li>

            </ul>
        </aside>
    </div>

    <footer class="footer">
        <div class="contenedor">
            <div class="barra">
                <a class="logo" href="index.html">
                    <h1 class="logo_nombre no-margin centrar-texto">Think&<span class="logo_bold">Coffe</span>'house</h1>
                </a>

                <nav class="navegacion">
                    <a href="#" class="navegacion_enlace">Nosotros</a>
                    <a href="#" class="navegacion_enlace">Productos</a>
                    <a href="#" class="navegacion_enlace">Contacto</a>
                </nav>
            </div>
        </div>
    </footer>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const token = localStorage.getItem('access_token');
            const loginLink = document.getElementById('login-link');
            const usuarioInfo = document.getElementById('usuario-info');
            const nombreUsuario = document.getElementById('nombre-usuario');
            const menu = document.querySelector('.usuario-menu');

            if (token) {
                fetch('/api/usuarios/me/', {
                    method: 'GET',
                    headers: {
                        'Authorization': 'Bearer ' + token
                    }
                })
                .then(response => {
                    if (!response.ok) throw new Error('No autorizado');
                    return response.json();
                })
                .then(data => {
                    nombreUsuario.textContent = data.username;
                    loginLink.style.display = 'none';
                    usuarioInfo.style.display = 'inline-block';
                })
                .catch(error => {
                    console.error('Error al obtener los datos del usuario', error);
                    localStorage.removeItem('access_token');
                    usuarioInfo.style.display = 'none';
                    loginLink.style.display = 'inline-block';
                });
            }

            usuarioInfo.addEventListener('click', (event) => {
                event.stopPropagation();
                menu.style.display = (menu.style.display === 'block') ? 'none' : 'block';
            });

            document.addEventListener('click', (event) => {
                if (!usuarioInfo.contains(event.target)) {
                    menu.style.display = 'none';
                }
            });

            document.getElementById('update-password').addEventListener('click', (e) => {
                e.stopPropagation();
                const nuevaClave = prompt('Introduce tu nueva contraseña:');
                if (nuevaClave) {
                    fetch('/api/usuarios/cambiar_contrasena/', {
                        method: 'POST',
                        headers: {
                            'Authorization': 'Bearer ' + token,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ nueva_clave: nuevaClave })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.mensaje) {
                            alert('Contraseña actualizada correctamente');
                        } else {
                            alert('Error al actualizar la contraseña');
                        }
                    })
                    .catch(error => {
                        console.error('Error al cambiar la contraseña', error);
                    });
                }
            });

            document.getElementById('delete-account').addEventListener('click', (e) => {
                e.stopPropagation();
                if (confirm('¿Seguro que quieres eliminar tu cuenta?')) {
                    fetch('/api/usuarios/eliminar_cuenta/', {
                        method: 'DELETE',
                        headers: {
                            'Authorization': 'Bearer ' + token
                        }
                    })
                    .then(response => {
                        if (response.ok) {
                            alert('Tu cuenta ha sido eliminada.');
                            localStorage.removeItem('access_token');
                            window.location.href = '{% url "index" %}';
                        } else {
                            alert('Hubo un error al eliminar tu cuenta.');
                        }
                    })
                    .catch(error => {
                        console.error('Error al eliminar la cuenta', error);
                    });
                }
            });
        });
    </script>

</body>

</html>
